name: Merge dev to main

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  validate-merge:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate source branch is dev
      run: |
        HEAD_BRANCH="${{ github.head_ref }}"
        if [[ "$HEAD_BRANCH" != "dev" ]]; then
          echo "❌ Error: Only the 'dev' branch can be merged into 'main'"
          echo "Current source branch: $HEAD_BRANCH"
          echo ""
          echo "Please create feature branches from 'dev' and merge them to 'dev' first."
          exit 1
        fi
        echo "✓ Source branch is 'dev' - merge is allowed"

    - name: Check for version bump
      run: |
        git fetch origin main
        OLD_VERSION=$(git show origin/main:pyproject.toml | grep '^version' | cut -d'"' -f2)
        NEW_VERSION=$(grep '^version' pyproject.toml | cut -d'"' -f2)
        
        echo "Old version: $OLD_VERSION"
        echo "New version: $NEW_VERSION"
        
        if [[ "$OLD_VERSION" == "$NEW_VERSION" ]]; then
          echo "⚠️ Warning: Version has not been bumped in pyproject.toml"
          echo "Please update the version before merging to main"
          exit 1
        fi
        echo "✓ Version has been bumped from $OLD_VERSION to $NEW_VERSION"

  full-test-suite:
    needs: validate-merge
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.7', '3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run full test suite
      run: |
        pytest --cov=rock_paper_scissors --cov-report=term-missing

  security-scan:
    needs: validate-merge
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety

    - name: Security scan
      run: |
        bandit -r src/rock_paper_scissors -ll
        safety check || true

  build-test:
    needs: validate-merge
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Build package
      run: |
        python -m pip install --upgrade pip build
        python -m build

    - name: Test package installation
      run: |
        pip install dist/*.whl
        rock-paper-scissors --help || echo "Package installed successfully"

  approve-merge:
    needs: [validate-merge, full-test-suite, security-scan, build-test]
    runs-on: ubuntu-latest

    steps:
    - name: All checks passed
      run: |
        echo "✓ All checks passed successfully"
        echo "✓ Source branch is 'dev'"
        echo "✓ Version has been bumped"
        echo "✓ All tests passed on all platforms"
        echo "✓ Security scan completed"
        echo "✓ Package build successful"
        echo ""
        echo "This PR is ready to be merged to main!"
